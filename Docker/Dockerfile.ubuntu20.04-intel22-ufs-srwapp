#FROM noaaepic/ubuntu20.04-spack:release-public-v2
FROM noaaepic/ubuntu20.04-spack:latest
LABEL AUTHOR EPIC-AUS

# install srw
WORKDIR /opt
#RUN git clone -b release/public-v2 https://github.com/ufs-community/ufs-srweather-app.git
RUN git clone -b develop https://github.com/ufs-community/ufs-srweather-app.git
WORKDIR /opt/ufs-srweather-app
COPY build-srw.sh /opt/ufs-srweather-app
RUN ./manage_externals/checkout_externals && \
    mkdir /opt/ufs-srweather-app/build && \
    /bin/bash -l /opt/ufs-srweather-app/build-srw.sh && \
    mkdir /opt/ufs
WORKDIR /opt/ufs
ENV PATH=$PATH:/opt/miniconda/bin
RUN wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh && \
    bash ./Miniconda3-latest-Linux-x86_64.sh -b -p /opt/miniconda && \
    git clone --recursive https://github.com/NOAA-GSD/contrib_miniconda3.git miniconda3 && \
    cd /opt/ufs/miniconda3/environments && \
    sed -i '3 a - conda-forge' regional_workflow.yml  && \
    sed -i 's/^-/  -/g' regional_workflow.yml  && \
    sed -i 's/^  - https/#  - https/g' regional_workflow.yml  && \
    cd /opt/ufs && \
    conda env create -f /opt/ufs/miniconda3/environments/regional_workflow.yml  && \
    mkdir -p /work && \
    mkdir -p /contrib && \
    mkdir -p /lustre  && \
    mkdir -p /scratch1 && \
    mkdir -p /scratch2 && \
    mkdir -p /glade && \
    mkdir -p /data && \
    mkdir -p /scratch && \
    mkdir -p /lfs && \
    mkdir -p /u && \
    mkdir -p /discover && \
    mkdir -p /mnt && \
    mkdir -p /lfs1 && \
    mkdir -p /lfs2 && \
    mkdir -p /lfs3 && \
    mkdir -p /lfs4 && \
    mkdir /opt/ufs-srweather-app/container-bin && \
    mv /opt/ufs-srweather-app/bin/* /opt/ufs-srweather-app/container-bin && \
    mkdir -p /opt/ufs-srweather-app/container-scripts     
COPY srw.sh-template /opt/ufs-srweather-app/container-scripts
COPY stage-srw.sh /opt/ufs-srweather-app/container-scripts
ENV FI_PROVIDER_PATH=/opt/spack-stack/spack/opt/spack/linux-ubuntu20.04-skylake/gcc-9.4.0/intel-oneapi-mpi-2021.6.0-oeymd7y2mkbdxex2tzf7354yhwpnvhoq/mpi/2021.6.0/libfabric/lib/prov:/usr/lib64/libfabric

